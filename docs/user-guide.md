# User Guide

pygeoapi-prefect is a plugin for pygeoapi that provides a custom process/job manager that uses prefect.

## Installation

In time, this project will be available in the python package index (AKA pypi) and be installable via pip, but for
now you can install it by git cloning and then using poetry to install

```shell
git clone https://github.com/geobeyond/pygeoapi-prefect.git
cd pygeoapi-prefect
poetry install
```

Check the [Development](development.md) section for a more developer oriented
installation procedure


## Enabling the pygeoapi-prefect process manager

pygeoapi-prefect provides a custom process/job manager for pygeoapi. In order to use it, modify
the pygeoapi configuration file.

Specifically, the `server.manager` configuration parameter needs to be set to 
`pygeopai_prefect.manager.PrefectManager`.


```yaml
# pygeoapi config file

server:
  manager:
    name: pygeoapi_prefect.manager.PrefectManager
```

## Processes

This project can be used to run pygeoapi processes of two different kinds:

- [Standard pygeoapi processes](#running-standard-pygeoapi-processes)
- [Custom prefect-powered processes](#running-prefect-powered-processes)


### Running standard pygeoapi processes

Pre-existing pygeoapi processes can simply be run by the `pygeoapi-prefect` pygeoapi process manager without any
modification. 

When using this option it is not possible to take advantage of most prefect features. Processes are always run 
locally, and it is not possible to use prefect features other than its ephemeral API and the UI for monitoring 
execution of processes. Other prefect features such as deployments and result storage are not available.


### Running prefect-powered processes

In order to take full advantage of pygeoapi-prefect you will need to use its custom process class as a base
for your own processes.

Prefect-based processes are able to use all prefect features such as blocks, deployments, scheduling, etc.

As such, in order to use prefect-powered processes you will need to:

1. [Write the code that performs the computation as a prefect flow](#implement-process-as-a-prefect-flow)
2. [Define the pygeoapi process class](#define-pygeoapi-process-class)
3. [Enable the process in pygeoapi configuration file](#enable-process-in-pygeoapi)
4. Ensure you have prefect running
5. Deploy your flow


#### Implement process as a prefect flow

!!! note

    We recommend getting having the [prefect docs](https://docs.prefect.io/2.10.15/) at hand when defining new flows.

In order for a prefect flow to be usable as the `process_flow` of a pygeoapi process,
there are some requirements that must be met:

1. The `@flow()` decorator must at least include the `persist_result=True` parameter;

2. Flows **must** accept the following parameters:

    - `job_id: str` - The pygeoapi job id, as generated by its process manager

    - `result_storage_block: str` - the extended name (_i.e._ `<block-type-slug>/<block-name>`) of a prefect block that
      is to be used for storing whatever outputs are to be generated during execution

    - `process_description: ProcessDescription` - The details about the processor, as known by pygeoapi

    - `execution_request: ExecuteRequest` - Execution-related details about the current pygeoapi job to be used in the
      flow run

3. Flows must store whatever results they produce using a prefect storage block

4. Flows must return an instance of `pygeoapi.models.processes.JobStatusInfoInternal`


A simple example:

```python
from prefect import flow, get_run_logger
from prefect.blocks.core import Block
from prefect.filesystems import LocalFileSystem
from pygeoapi.models import processes as schemas
from pygeoapi.process import exceptions


@flow(persist_result=True)
def simple_flow(
        job_id: str,
        result_storage_block: str | None,
        process_description: schemas.ProcessDescription,
        execution_request: schemas.ExecuteRequest
) -> schemas.JobStatusInfoInternal:
  """This is a simple prefect flow.
  
  This is just a regular prefect flow. It respects pygeoapi's 
  requirements, namely:
  
  - The @flow decorator includes `persist_results=True`
  
  - Accepts the required input parameters (job_id, result_storage_block, 
  process_description, execution_request)
  
  - Stores outputs using prefect block
  
  - Returns a status_info
  
  """
  logger = get_run_logger()
  logger.debug("Starting execution...")
  
  # 1. retrieve inputs
  # 1.1. some may be mandatory
  try:
    name = execution_request.inputs["name"].__root__
  except KeyError:
    raise exceptions.MissingJobParameterError("Cannot process without a name")
  else:
      
    # 1.2. others may be optional
    msg = execution_request.inputs.get("message")
    message = msg.__root__ if msg is not None else ""

    # 2. determine where results will be stored
    if result_storage_block is not None:
      storage = Block.load(result_storage_block)
    else:
      storage = LocalFileSystem()

    # 3. Get to work! - Perform the generation of outputs
    result_value = f"Hello {name}! {message}".strip()

    # 4. Store the generated outputs using a prefect block
    result_path = f"{job_id}/output-result.txt"
    storage.write_path(result_path, result_value.encode("utf-8"))

    # 5. Return a status info object
    return schemas.JobStatusInfoInternal(
      jobID=job_id,
      processID=process_description.id,
      status=schemas.JobStatus.successful,
      generated_outputs={
        "result": schemas.OutputExecutionResultInternal(
          location=f"{storage.basepath}/{result_path}",
          media_type=(
            process_description.outputs["result"].schema_.content_media_type
          ),
        )
      },
    )
```


#### Define pygeoapi process class

Prefect-powered processes need to:

- Derive from `BasePrefectProcessor` - This custom base class provides prefect-related functionality

- Have the `process_flow` class variable. This is a reference to the prefect flow function which is
  used for doing the work. See below how to implement a suitable flow.

- Have the `process_description` class variable. This must be an instance of `ProcessDescription`.
  It is a description of the process, including its inputs as outputs. The only major requirement here is that the
  description's `id` property needs to match the name of the process, as specified in the pygeoapi 
  configuration file

A simple example, meant to work together with [the prefect flow defined earlier](#implement-process-as-a-prefect-flow):


```python
from prefect import flow
from pygeoapi.models import processes as schemas
from pygeoapi_prefect.process.base import BasePrefectProcessor

@flow(persist_result=True)
def simple_flow(
        job_id: str,
        result_storage_block: str | None,
        process_description: schemas.ProcessDescription,
        execution_request: schemas.ExecuteRequest
) -> schemas.JobStatusInfoInternal:
    ...  # omitted for brevity


# Our custom pygeoapi processor, with its two mandatory properties (process_flow, and process_description)
class SimpleFlowProcessor(BasePrefectProcessor):
    process_flow = simple_flow
    process_description = schemas.ProcessDescription(
        id="simple-flow",  # id MUST match key given in pygeoapi config
        version="0.0.1",
        title="Simple flow Processor",
        jobControlOptions=[
            schemas.ProcessJobControlOption.SYNC_EXECUTE,
            schemas.ProcessJobControlOption.ASYNC_EXECUTE
        ],
        inputs={
            "name": schemas.ProcessInput(
                title="Name",
                schema=schemas.ProcessIOSchema(type=schemas.ProcessIOType.STRING)
            ),
            "message": schemas.ProcessInput(
                title="Message",
                schema=schemas.ProcessIOSchema(type=schemas.ProcessIOType.STRING),
                minOccurs=0
            ),
        },
        outputs={
            "result": schemas.ProcessOutput(
                schema=schemas.ProcessIOSchema(type=schemas.ProcessIOType.STRING, contentMediaType="text/plain")
            )
        },
    )
```


## Enable process in pygeoapi

In order to be used, a process must be specified in pygeoapi configuration file. pygeoapi-prefect
recognizes the following process-related configuration:

- `processor.name` - dotted path to the pygeoapi processor class to be used

- `processor.prefect.result_storage` - identifier of the prefect storage block that is to be used for storing 
   generated outputs. Flow runs must always use a storage block to store execution outputs.

- `processor.prefect.deployment.name` - name of the prefect deployment that will be created/used

- `processor.prefect.deployment.queue` - name of the prefect queue where flow runs will be scheduled to

- `processor.prefect.deployment.storage_block` - identifier of the prefect storage block that is to be used for storing the flow deployment

- `processor.prefect.deployment.storage_sub_path` - path for storing the flow deployment 

A simple example:

```yaml
# pygeoapi configuration file

resources:
  
  # id of the process MUST be the same as the `id` property of the processor's 
  # `process_description`
  hi-prefect-world:
    type: process
    processor:
      name: pygeoapi_prefect.examples.hi_prefect_world.HiPrefectWorldProcessor
      prefect:
        result_storage: remote-file-system/test-sb1-results
        deployment:
          name: minio
          queue: pygeoapi
          storage_block: remote-file-system/test-sb1
          storage_sub_path: hi-prefect-world-flow
```


## Run prefect

!!! Note

    Prefect uses a hybrid model whereby the orchestration components are separated from the
    execution ones. This means that it is possible to use a hosted prefect server (i.e. prefect cloud)
    for the orchestration and use your own infrastructure (local, cloud, docker, k8s) for execution.
    This ensures your data stays private.

In order to take full advantage of pygeoapi-prefect, you will need to run, or have access 
to, the following prefect components:

- prefect server - This is the main component of prefect's orchestration layer. It features web user 
  interface which can be used to monitor flow run execution. It can be run either on your own 
  infrastructure or on prefect cloud. For example, in order to launch it locally:

  ```shell
  prefect server start
  ```
  
  The web UI will now be accessible at

- prefect agent - This must be running on your infrastructure


## Deploying a process

Prefect-based processes can be deployed by prefect onto appropriate blocks, thus enabling their future usage on
non-local nodes.

- run the CLI command




## Execute process

- Examples:
  - sync execution without deployment

    ```shell
    http localhost:5000/processes/simple-flow/execution \
        inputs:='{"name": "John Doe"}'
    ```
  - async execution without deployment (currently not supported)

  - sync execution with deployment (warn about not using a reloader web server)

    ```shell
    http localhost:5000/processes/simple-flow/execution \
        inputs:='{"name": "John Doe"}'
    ```

  - async execution with deployment

    ```shell
    http localhost:5000/processes/simple-flow/execution \
        Prefer:respond-async \
        inputs:='{"name": "John Doe"}' \
    ```

  - async execution with deployment and using a response of type `document`

    ```shell
    http localhost:5000/processes/simple-flow/execution \
        Prefer:respond-async \
        response=document \
        inputs:='{"name": "John Doe"}'
    ```

  - async execution with deployment and using a response of type `document` with result being requested by reference

    ```shell
    http localhost:5000/processes/simple-flow/execution \
        Prefer:respond-async \
        response=document \
        inputs:='{"name": "John Doe"}'
        outputs:='{"result": {"transmissionMode": "reference"}}'
    ```


### Retrieve execution results

- with a storage block
- without it





[prefect-processes](prefect-processes.md)


### Using prefect deployments and storage blocks

This example shall use minIO to store data. Let's start by standing up a local docker container with minIO:

```shell
mkdir -p ~/minio/data

docker run \
    --publish 9000:9000 \
    --publish 9090:9090 \
    --name minio \
    --volume ~/minio/data:/data \
    --env "MINIO_ROOT_USER=tester" \
    --env "MINIO_ROOT_PASSWORD=12345678" \
    quay.io/minio/minio \
    server /data --console-address ":9090"
```

Login to the minIO dashboard at http://127.0.0.1:9090 then go ahead and create a bucket named `pygeoapi-test`

Now you need to create a storage block that references this bucket. Either use the custom pygeoapi-prefect CLI command
or create the block using Prefect dashboard. With the CLI command:

```shell
poetry run pygeoapi-prefect create-storage-block \
    test-sb1 \
    s3://pygeoapi-test \
    http://localhost:9000 \
    tester \
    12345678
```

Using the Prefect CLI You may create a block of type *Remote File System*:

- name: `test-sb1`
- basepath: `s3://pygeoapi-test`
- settings:
  ```json
  {
    "key": "tester",
    "secret": "12345678",
    "client_kwargs": {
      "endpoint_url": "http://localhost:9000"
    }
  }
  ```

After having created the block in prefect, we can now deploy our pygeoapi process:

```shell
PYGEOAPI_CONFIG=example-config.yml poetry run pygeoapi-prefect deploy-process-as-flow hi-prefect-world
```

This results in prefect creating a deployment named `hi-prefect-world/test`, and since we are specifying a storage
block, prefect also uploads the flow code onto the storage (which is the minIO bucket created previously).

```shell

# this shall show our deployment name
poetry run prefect deployment ls

poetry run prefect deployment inspect hi-prefect-world/test
```

We should now be able to run our deployment - first by using the prefect CLI:

```shell
poetry run prefect deployment run hi-prefect-world/minio \
  --param name=johnny \
  --param message=wazaaap \
  --param pygeoapi_job_id=test-id-1
```

Then from the prefect dashboard, by selecting the deployment and clicking on _Run -> Custom run..._ (where we can
specify values for the flow parameters, just as we did before in the CLI example)

Finally, we ought to be able to trigger a run of this deployment by leveraging pygeoapi's support for OAPI - Processes:

```shell
http -v localhost:5000/processes/hi-prefect-world/execution inputs:='{"name": "Frankie Four-fingers"}'
```
